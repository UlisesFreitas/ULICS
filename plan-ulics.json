{
  "projectName": "ULICS Fantasy Console",
  "description": "Development plan for a high-performance fantasy console with C++/SDL, separating logic and aesthetics.",
  "file_structure": [
    "U:/ULICS/",
    "├── .gitignore",
    "├── build.ps1",
    "├── CMakeLists.txt",
    "├── plan-ulics.json",
    "├── src/",
    "│   ├── core/",
    "│   │   ├── Engine.cpp",
    "│   │   └── Engine.h",
    "│   ├── demos/",
    "│   │   ├── DemoGame.cpp",
    "│   │   └── DemoGame.h",
    "│   ├── game/",
    "│   │   └── Game.h",
    "│   ├── rendering/",
    "│   │   ├── AestheticLayer.cpp",
    "│   │   └── AestheticLayer.h",
    "│   └── main.cpp",
    "└── (build/, sdl/)"
  ],
  "phases": [
    {
      "phase": 0,
      "title": "Build Automation and Environment",
      "description": "Establish a robust and automated development environment that manages dependencies, compilation, and project cleanup.",
      "tasks": [
        {
          "id": "0.1",
          "description": "Create a build script (build.ps1) that automates the entire process.",
          "status": "completed",
          "files": "build.ps1"
        },
        {
          "id": "0.2",
          "description": "The script must clean the build directory ('build') before each run to ensure a clean build.",
          "status": "completed",
          "files": "build.ps1"
        },
        {
          "id": "0.3",
          "description": "The script must terminate any running application instance ('UliCS.exe') before compiling.",
          "status": "completed",
          "files": "build.ps1"
        },
        {
          "id": "0.4",
          "description": "Generate a build log ('build_log.txt') with the complete process output.",
          "status": "completed",
          "files": "build.ps1"
        },
        {
          "id": "0.5",
          "description": "Automate dependency fetching and compilation (clone SDL2 from the repository if it doesn't exist).",
          "status": "completed",
          "files": "build.ps1, .gitignore"
        }
      ]
    },
    {
      "phase": 1,
      "title": "Initial Setup and Project Baseline",
      "description": "Establish the project structure, build system, and basic application window. The goal is to have a functional 'Hello World' that demonstrates the environment is correctly configured.",
      "libraries": [
        {
          "name": "SDL2",
          "purpose": "Main library for window management, 2D rendering, and input events."
        }
      ],
      "tasks": [
        {
          "id": "1.1",
          "description": "Define and create the project's directory structure (src, build, cartridges, assets).",
          "status": "completed",
          "files": "src/"
        },
        {
          "id": "1.2",
          "description": "Configure CMake to compile the project and link SDL2 statically.",
          "status": "completed",
          "files": "CMakeLists.txt"
        },
        {
          "id": "1.3",
          "description": "Create a basic application that initializes SDL, opens a window, and demonstrates that static linking works.",
          "status": "completed",
          "files": "src/main.cpp"
        },
        {
          "id": "1.4",
          "description": "Create the main 'Engine' class to encapsulate SDL initialization, the window, and the main loop.",
          "status": "completed",
          "files": "src/Engine.h, src/Engine.cpp, src/main.cpp"
        }
      ]
    },
    {
      "phase": 2,
      "title": "Engine Architecture (Dual Layer)",
      "description": "Implement the core of the dual-layer architecture: the aesthetic rendering layer and the game logic layer.",
      "libraries": [
        {
          "name": "SDL2",
          "purpose": "Continues to be the foundation for rendering."
        }
      ],
      "tasks": [
        {
          "id": "2.1",
          "description": "Develop the 'Aesthetic Layer': a class that manages a low-resolution framebuffer (e.g., 256x256) and a base 16-color palette.",
          "status": "completed",
          "files": "src/AestheticLayer.h, src/AestheticLayer.cpp, src/Engine.h, src/Engine.cpp"
        },
        {
          "id": "2.2",
          "description": "Implement the basic drawing API in the Aesthetic Layer (PSET, LINE, RECT) that operates on the framebuffer.",
          "status": "completed",
          "files": "src/AestheticLayer.h, src/AestheticLayer.cpp, src/Engine.cpp"
        },
        {
          "id": "2.3",
          "description": "Create a mechanism to scale and render the Aesthetic Layer's framebuffer to the main SDL window.",
          "status": "completed",
          "files": "src/Engine.cpp, src/AestheticLayer.cpp"
        },
        {
          "id": "2.4",
          "description": "Develop the 'Logic Layer' which will contain the _update() and _draw() functions and will call the Aesthetic Layer's API.",
          "status": "completed",
          "files": "src/core/, src/demos/, src/game/, src/rendering/, CMakeLists.txt, todos los archivos .h/.cpp"
        },
        {
          "id": "2.5",
          "description": "Separate the update logic (_update) from the drawing logic (_draw) in the Logic Layer for a decoupled game loop.",
          "status": "completed",
          "files": "src/game/Game.h, src/demos/DemoGame.h, src/demos/DemoGame.cpp, src/core/Engine.cpp"
        },
        {
          "id": "2.6",
          "description": "Implement a fixed timestep game loop to decouple logic from rendering speed.",
          "status": "completed",
          "files": "src/core/Engine.h, src/core/Engine.cpp"
        }
      ]
    },
    {
      "phase": 3,
      "title": "Scripting Integration (Lua C API)",
      "description": "Incorporate the **Lua** scripting engine using its native C API for maximum control. The game logic will be written by the end-user, and we will connect the engine's API to Lua.",
      "libraries": [
        {
          "name": "Lua (C API)",
          "purpose": "The main scripting engine. The native C API (or a lightweight C++ wrapper) will be used for binding."
        }
      ],
      "tasks": [
        {
          "id": "3.1",
          "description": "Integrate the **Lua** static library into the project (compile from source or use vcpkg) via CMake.",
          "status": "completed"
        },
        {
          "id": "3.2",
          "description": "Create a 'ScriptingManager' class to manage the Lua state (`lua_State`), load, and execute scripts.",
          "status": "completed"
        },
        {
          "id": "3.3",
          "description": "Expose (bind) the Aesthetic Layer's API functions (PSET, LINE, etc.) to the Lua environment using the **Lua C API**.",
          "status": "completed"
        },
        {
          "id": "3.4",
          "description": "Modify the engine's main loop to call the main functions (_update(), _draw()) of the loaded Lua script.",
          "status": "completed",
          "notes": "Implemented using an embedded script for a self-contained executable."
        },
        {
          "id": "3.5",
          "description": "Expand the core drawing API in Lua: `circ`, `circfill`, and `pget`.",
          "status": "completed"
        },
        {
          "id": "3.6",
          "description": "Implement a basic `InputManager` to track keyboard state.",
          "status": "completed"
        },
        {
          "id": "3.7",
          "description": "Expose input functions to Lua: `btn(i)` and `btnp(i)`.",
          "status": "completed"
        },
        {
          "id": "3.8",
          "description": "Embed a default bitmap font and expose a `print(str, x, y, color)` function to Lua.",
          "status": "completed"
        },
        {
          "id": "3.9",
          "description": "Improve runtime error handling to display Lua errors on-screen instead of only in the console.",
          "status": "completed",
          "notes": "Engine now enters an error state and renders the Lua error message directly to the screen."
        },
        {
          "id": "3.10",
          "description": "Expose a `time()` function to Lua that returns the elapsed time since engine start.",
          "status": "completed",
          "notes": "Refactored ScriptingManager to hold a pointer to the Engine for easier access to subsystems."
        },
        {
          "id": "3.11",
          "description": "Expose convenience math functions (`sin`, `cos`, `rnd`, `flr`, etc.) to the global Lua namespace.",
          "status": "completed",
          "notes": "Added sin, cos, atan2, sqrt, abs, flr, ceil, and rnd. Adopted PICO-8 angle conventions."
        },
        {
          "id": "3.12",
          "description": "Implement and expose a `camera(x, y)` function to offset all subsequent drawing operations.",
          "status": "completed",
          "notes": "Added camera(x, y) offset to AestheticLayer and exposed it to Lua. All drawing primitives now respect the camera."
        },
        {
          "id": "3.13",
          "description": "Implement and expose a function **`tcolor(color_id)`** that sets the current **transparent** color index in the `AestheticLayer`, vital for future `SPRITE` operations.",
          "status": "completed"
        }
      ]
    },
    {
      "phase": 3.5,
      "title": "Prerequisites for Phase 4 (Cartridge System Foundation)",
      "description": "Implement critical infrastructure required for the cartridge system: dynamic palette support, external file loading, engine state management, and cartridge lifecycle management.",
      "tasks": [
        {
          "id": "3.14",
          "description": "Add dynamic palette support to `AestheticLayer`: implement methods to change palette size (16, 32, 64, 128 colors), load custom palettes, and modify individual palette entries.",
          "status": "completed",
          "files": "src/rendering/AestheticLayer.h, src/rendering/AestheticLayer.cpp"
        },
        {
          "id": "3.15",
          "description": "Extend `ScriptingManager` to support loading Lua scripts from external files with `LoadScriptFromFile(filepath)` method.",
          "status": "completed",
          "files": "src/scripting/ScriptingManager.h, src/scripting/ScriptingManager.cpp"
        },
        {
          "id": "3.16",
          "description": "Implement a comprehensive **Engine State Machine** with states: `BOOT`, `MENU`, `LOADING_CARTRIDGE`, `RUNNING_CARTRIDGE`, `ERROR`. Include state transition logic and validation.",
          "status": "completed",
          "files": "src/core/Engine.h, src/core/Engine.cpp"
        },
        {
          "id": "3.17",
          "description": "Add cartridge lifecycle management to `Engine`: implement `LoadCartridge(path)`, `UnloadCartridge()`, and `ReloadCurrentCartridge()` methods to support dynamic cartridge loading.",
          "status": "completed",
          "files": "src/core/Engine.h, src/core/Engine.cpp"
        },
        {
          "id": "3.18",
          "description": "Expose `cls()` as a convenience alias for `clear()` in the Lua API, following PICO-8 conventions for better user experience.",
          "status": "completed",
          "files": "src/scripting/ScriptingManager.cpp, LUA_API.md"
        },
        {
          "id": "3.19",
          "description": "Update task 5.1 status to reflect that `InputManager` and input functions (`btn`, `btnp`) are already implemented in Phase 3.",
          "status": "completed",
          "files": "plan-ulics.json"
        },
        {
          "id": "3.20",
          "description": "Modify `Engine::Initialize()` to accept an optional cartridge path parameter. If empty, load embedded demo; if specified, load external cartridge; prepare for menu system.",
          "status": "completed",
          "files": "src/core/Engine.h, src/core/Engine.cpp, src/main.cpp"
        }
      ]
    },
    {
      "phase": 4,
      "title": "Cartridge System (High-Performance Fantasy Console)",
      "description": "Implement ULICS's cartridge system with its unique selling point: massive resources (512MB-1GB RAM, 1M lines of Lua) in a fantasy console package. Cartridges remain self-contained Lua files but can be HUGE compared to PICO-8/TIC-80. This enables ambitious projects like complex RPGs, procedural worlds, or AI-driven games.",
      "philosophy": "ULICS differentiates from PICO-8/TIC-80 by offering modern resources with retro aesthetics. Developers get generous limits (configurable per cartridge) to create complex games while maintaining the 'everything in code' fantasy console philosophy. Sprites, maps, and data are Lua tables, but you can have MILLIONS of tiles, thousands of sprites, or complex procedural generation.",
      "cartridge_structure": "cartridges/my_game/main.lua (+ optional config.json). No external assets - all data is Lua code, but with 512MB-1GB to work with.",
      "libraries": [
        {
          "name": "nlohmann/json",
          "purpose": "Parse optional config.json files for cartridge metadata and configuration."
        }
      ],
      "tasks": [
        {
          "id": "4.1",
          "description": "Design the cartridge structure and config.json format. Config includes: metadata (name, author, version), console settings (palette_size, framebuffer_width, framebuffer_height), and **critical resource limits** (memory_limit_mb: 512-1024MB, lua_code_limit_lines: up to 1,000,000). These generous limits differentiate ULICS from PICO-8/TIC-80.",
          "status": "completed",
          "notes": "Example config.json: {\"name\": \"Epic RPG\", \"author\": \"Dev\", \"memory_limit_mb\": 768, \"lua_code_limit_lines\": 500000, \"palette_size\": 128}",
          "files": "CARTRIDGE_SPEC.md"
        },
        {
          "id": "4.2",
          "description": "Integrate nlohmann/json library into CMake build system.",
          "status": "completed",
          "files": "CMakeLists.txt, build.ps1"
        },
        {
          "id": "4.3",
          "description": "Create `CartridgeConfig` struct to hold cartridge metadata and settings parsed from config.json.",
          "status": "completed",
          "files": "src/cartridge/CartridgeConfig.h"
        },
        {
          "id": "4.4",
          "description": "Implement `CartridgeLoader` class with methods: `loadCartridge(path)`, `listAvailableCartridges(directory)`, and `parseConfig(path)`.",
          "status": "completed",
          "files": "src/cartridge/CartridgeLoader.h, src/cartridge/CartridgeLoader.cpp"
        },
        {
          "id": "4.5",
          "description": "Integrate `CartridgeLoader` with `Engine::LoadCartridge()` to parse config.json and apply settings (palette size, etc.) before loading main.lua.",
          "status": "completed",
          "files": "src/core/Engine.cpp, src/core/Engine.h"
        },
        {
          "id": "4.6",
          "description": "Create `cartridges/` directory structure and implement at least 2 example cartridges (e.g., 'hello_world' and 'bouncing_ball') to test the system.",
          "status": "completed",
          "files": "cartridges/hello_world/main.lua, cartridges/hello_world/config.json, cartridges/bouncing_ball/main.lua, cartridges/bouncing_ball/config.json, cartridges/README.md"
        },
        {
          "id": "4.7",
          "description": "Create `system/menu.lua` - a special internal cartridge that scans and displays available cartridges, allowing the user to select one to load.",
          "status": "completed",
          "files": "src/scripting/SystemScripts.h",
          "notes": "Menu uses placeholder functions get_cartridge_list() and load_cartridge() which will be implemented in tasks 4.9-4.10"
        },
        {
          "id": "4.8",
          "description": "Modify `Engine::Initialize()` boot logic: if no cartridge path is provided, enter `STATE_MENU` and load the system menu script.",
          "status": "completed",
          "files": "src/core/Engine.cpp"
        },
        {
          "id": "4.9",
          "description": "Expose Lua function `load_cartridge(name)` to allow the menu script to dynamically load selected cartridges.",
          "status": "completed",
          "files": "src/scripting/ScriptingManager.h, src/scripting/ScriptingManager.cpp"
        },
        {
          "id": "4.10",
          "description": "Add `list_cartridges()` Lua function to return available cartridges as a Lua table for the menu system.",
          "status": "completed",
          "files": "src/scripting/ScriptingManager.h, src/scripting/ScriptingManager.cpp"
        },
        {
          "id": "4.11",
          "description": "Implement resource limit enforcement: track Lua memory usage (via `lua_gc`) and code line count. Display warnings/stats but allow configurable limits per cartridge (512MB-1GB RAM, up to 1M lines). This is a CORE differentiator of ULICS.",
          "status": "completed",
          "files": "src/scripting/ScriptingManager.h, src/scripting/ScriptingManager.cpp, src/core/Engine.cpp",
          "notes": "Limits are informative (show current usage) but not rigid. Warnings shown when exceeding 80% or 100% of configured limits."
        }
      ]
    },
    {
      "phase": 4.5,
      "title": "Stabilization & API Completion",
      "description": "Critical fixes and missing implementations discovered during Phase 4. Ensures solid foundation before expanding to Phase 5.",
      "libraries": [],
      "tasks": [
        {
          "id": "4.5.1",
          "description": "Implement circfill() - Critical missing function marked as implemented in LUA_API.md but not actually coded. Needed for filled circles.",
          "status": "completed",
          "priority": "CRITICAL",
          "files": "src/rendering/AestheticLayer.h, src/rendering/AestheticLayer.cpp, src/scripting/ScriptingManager.cpp, LUA_API.md",
          "notes": "Verified: circfill() IS fully implemented - C++ function exists in AestheticLayer.cpp (line 231), Lua bridge exists in ScriptingManager.cpp (line 212), and is registered in RegisterAPI(). The bouncing_ball demo issue was physics bugs, not missing circfill()."
        },
        {
          "id": "4.5.2",
          "description": "Implement visual error screen - Show Lua errors to user with red screen + scrollable error message instead of just black screen.",
          "status": "pending",
          "priority": "CRITICAL",
          "files": "src/core/Engine.cpp, src/rendering/AestheticLayer.cpp"
        },
        {
          "id": "4.5.3",
          "description": "Add system control functions to Lua API: exit(), reset(), goto_menu() for better cartridge control flow.",
          "status": "pending",
          "priority": "HIGH",
          "files": "src/scripting/ScriptingManager.h, src/scripting/ScriptingManager.cpp, src/core/Engine.h, src/core/Engine.cpp, LUA_API.md"
        },
        {
          "id": "4.5.4",
          "description": "Create comprehensive API test cartridge that systematically tests every implemented Lua function with visual feedback.",
          "status": "pending",
          "priority": "HIGH",
          "files": "cartridges/api_test/main.lua, cartridges/api_test/config.json"
        },
        {
          "id": "4.5.5",
          "description": "Fix bouncing_ball demo with proper physics that actually works, or replace with a better visual demo.",
          "status": "pending",
          "priority": "MEDIUM",
          "files": "cartridges/bouncing_ball/main.lua"
        },
        {
          "id": "4.5.6",
          "description": "Update README.md with current project state, build instructions, cartridge guide, and quick start tutorial.",
          "status": "pending",
          "priority": "MEDIUM",
          "files": "README.md"
        },
        {
          "id": "4.5.7",
          "description": "Audit all functions marked as ✅ in LUA_API.md - verify they're actually implemented and working correctly.",
          "status": "pending",
          "priority": "HIGH",
          "files": "LUA_API.md, src/scripting/ScriptingManager.cpp"
        }
      ]
    },
    {
      "phase": 5,
      "title": "API Expansion and Features",
      "description": "Add essential features to a fantasy console, such as advanced user input, audio, and a richer drawing API.",
      "libraries": [
        {
          "name": "SDL2_mixer",
          "purpose": "To manage audio and music playback."
        },
        {
          "name": "SDL2_image",
          "purpose": "To load sprites from image files (PNG)."
        }
      ],
      "tasks": [
        {
          "id": "5.1",
          "description": "Create an 'InputManager' to handle keyboard and gamepad, and expose a simple API to Lua (btn(), btnp()).",
          "status": "completed",
          "notes": "Already implemented in Phase 3 (tasks 3.6 and 3.7). InputManager exists and btn(), btnp() are exposed to Lua."
        },
        {
          "id": "5.2",
          "description": "Integrate SDL2_mixer and create an 'AudioManager' with functions to play sounds and music (sfx(), music()), exposed to Lua.",
          "status": "pending"
        },
        {
          "id": "5.3",
          "description": "Expand the drawing API in the Aesthetic Layer with SPRITE, CIRCLE, and other primitives. Expose to Lua.",
          "status": "pending"
        },
        {
          "id": "5.4",
          "description": "Implement a 'SpriteSheet' system that can be loaded from the cartridge's assets.",
          "status": "pending"
        },
        {
          "id": "5.5",
          "description": "Implement a function `mousetoggle(enabled)` to activate/deactivate the mouse cursor and expose the functions `mousex()`, `mousey()` to Lua for basic UI interaction.",
          "status": "pending"
        }
      ]
    },
    {
      "phase": 6,
      "title": "Finalization, Documentation, and Examples",
      "description": "Create a complete demo cartridge, document the API for end-users, and polish the project for its initial release.",
      "libraries": [],
      "tasks": [
        {
          "id": "6.1",
          "description": "Develop a demo cartridge (e.g., a simple game like Pong or a basic platformer) that uses all API features.",
          "status": "pending"
        },
        {
          "id": "6.2",
          "description": "Write comprehensive API documentation in Markdown format, explaining each Lua function, its parameters, and its behavior.",
          "status": "pending"
        },
        {
          "id": "6.3",
          "description": "Perform a general code review, refactor, and optimize where necessary before considering it v1.0.",
          "status": "pending"
        }
      ]
    }
  ]
}