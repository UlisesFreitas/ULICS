{
    "phase": 4,
    "title": "Map Editor",
    "description": "Tile map editor with multi-layer support - 128x64 tile grid, up to 8 layers, PICO-8 style vertical layout with tab-based spritesheet picker, zoom/pan navigation, and layer management sidebar.",
    "priority": "HIGH",
    "estimatedTime": "4-5 hours (core), 2-3 hours (enhancements), 3 hours (critical features)",
    "actualTime": "~8 hours (core + enhancements completed), ~3 hours pending",
    "status": "in_progress",
    "coreStatus": "completed",
    "enhancementsStatus": "completed",
    "criticalFeaturesStatus": "pending",
    "completionDate": "TBD (core: 2025-12-26, critical features pending)",
    "philosophy": "Powerful layer system for rich 2D worlds. PICO-8 simplicity with modern multi-layer support for depth and complexity. Professional zoom/pan navigation and visual feedback for productive map editing.",
    "objectives": [
        "✅ Create 128x64 tile grid map editor",
        "✅ Support up to 8 independent layers",
        "✅ Implement tab-based spritesheet picker (4 tabs × 64 tiles)",
        "✅ Add pencil, fill, eraser, and picker tools",
        "✅ Layer visibility toggle and active layer selection (1-8 keys)",
        "✅ Save/load map data to JSON format",
        "✅ Integrate with F3 toggle key",
        "✅ PICO-8 style vertical layout with proper borders",
        "✅ Load actual spritesheet from cartridge",
        "✅ Add layer management UI sidebar (toggle with L)",
        "✅ Implement 5-level zoom/pan with mouse wheel",
        "✅ Screen section grid for game layout visualization",
        "✅ Toast messages for user feedback"
    ],
    "tasks": [
        {
            "id": "4.1",
            "description": "Create MapEditor class structure",
            "status": "completed",
            "files": [
                "src/ui/MapEditor.h",
                "src/ui/MapEditor.cpp"
            ],
            "estimatedTime": "30 min",
            "actualTime": "45 min",
            "notes": "Class with 8 Layer structs, 128x64 tile grid, tool enum (PENCIL, FILL, ERASER, PICKER)"
        },
        {
            "id": "4.2",
            "description": "Implement tile grid viewport with scroll",
            "status": "completed",
            "estimatedTime": "1 hour",
            "actualTime": "1.5 hours",
            "notes": "Full-width map (254x150) with white border, arrow keys for camera pan, supports partial map rendering"
        },
        {
            "id": "4.3",
            "description": "Add tile picker panel from spritesheet",
            "status": "completed",
            "estimatedTime": "45 min",
            "actualTime": "2 hours",
            "notes": "16x4 grid (64 sprites per tab), 4 tabs for 256 total tiles, full-width (256px), 16x16 sprite display"
        },
        {
            "id": "4.4",
            "description": "Implement pencil tool for tiles",
            "status": "completed",
            "estimatedTime": "30 min",
            "actualTime": "20 min",
            "notes": "Click to place selected tile on active layer"
        },
        {
            "id": "4.5",
            "description": "Implement fill tool for tiles",
            "status": "completed",
            "estimatedTime": "45 min",
            "actualTime": "1 hour",
            "notes": "Iterative flood fill with queue (not recursive), 10k tile safety limit, respects map bounds"
        },
        {
            "id": "4.6",
            "description": "Add layer selector (0-7)",
            "status": "completed",
            "estimatedTime": "1 hour",
            "actualTime": "30 min",
            "notes": "8 layers with 1-8 key shortcuts, layer visibility toggles, active layer highlighted in status"
        },
        {
            "id": "4.7",
            "description": "Render multiple layers with transparency",
            "status": "completed",
            "estimatedTime": "45 min",
            "actualTime": "30 min",
            "notes": "Renders all visible layers bottom-to-top, tile 0 = transparent, proper layering"
        },
        {
            "id": "4.8",
            "description": "Implement save to JSON",
            "status": "completed",
            "estimatedTime": "45 min",
            "actualTime": "40 min",
            "notes": "Saves to cartridge/map.json with all 8 layers, metadata (width, height, version)"
        },
        {
            "id": "4.9",
            "description": "Implement load from JSON",
            "status": "completed",
            "estimatedTime": "30 min",
            "actualTime": "25 min",
            "notes": "Loads from map.json, validates structure, populates all layers"
        },
        {
            "id": "4.10",
            "description": "Integrate with Engine F3 toggle",
            "status": "completed",
            "estimatedTime": "15 min",
            "actualTime": "30 min",
            "notes": "F3 toggles GAME ↔ MAP_EDITOR, ESC returns to GAME, Engine::SetMode() integration with Initialize/SetActive"
        },
        {
            "id": "4.11",
            "description": "Add keyboard shortcuts and polish",
            "status": "completed",
            "estimatedTime": "30 min",
            "actualTime": "1 hour",
            "notes": "1-8 layer select, G grid toggle, Ctrl+S save, Arrow keys camera pan, SystemSprites icons"
        },
        {
            "id": "4.12",
            "description": "PICO-8 layout refinement and styling",
            "status": "completed",
            "estimatedTime": "N/A",
            "actualTime": "2 hours",
            "notes": "Vertical layout from bottom-up, full-width borders, tab styling match Sprite Editor, proper border spacing"
        },
        {
            "id": "4.13",
            "description": "Load current cartridge spritesheet",
            "status": "completed",
            "estimatedTime": "30 min",
            "actualTime": "45 min",
            "completionDate": "2025-12-25",
            "notes": "Sprites load from cartridge, hot-reload on editor switch (F2→F3), fixed duplicate rendering bug. MapEditor::SetActive() now takes AestheticLayer* to reload spritesheet"
        },
        {
            "id": "4.14",
            "description": "Add layer management UI panel",
            "status": "completed",
            "estimatedTime": "1.5 hours",
            "actualTime": "2 hours",
            "completionDate": "2025-12-26",
            "notes": "Implemented toggleable sidebar (60px wide) with LAYERS title, Show/Hide text for visibility, arrow indicator for active layer. Toggle with L key or header button. Click layer to activate, click Show/Hide to toggle visibility. Hover feedback with lavender background. Green background for active layer."
        },
        {
            "id": "4.15",
            "description": "Implement PICO-8 style zoom and pan",
            "status": "completed",
            "estimatedTime": "2 hours",
            "actualTime": "3 hours",
            "completionDate": "2025-12-25 to 2025-12-26",
            "notes": "5 discrete zoom levels (0.25x, 0.5x, 1x, 2x, 4x) with mouse wheel. Middle mouse + drag for panning. Snap-to-grid (8px). Checkboard background (8x8). Screen section grid (magenta) shows 64 game screens (128x64px each). Fixed DrawSpriteSection to support proper sprite scaling. Grid hidden at <1x zoom"
        },
        {
            "id": "4.16",
            "description": "Refactor magic values to constants",
            "status": "completed",
            "estimatedTime": "20 min",
            "actualTime": "25 min",
            "completionDate": "2025-12-26",
            "priority": "high",
            "notes": "Extracted all hardcoded coordinates to named constants: TOGGLE_BTN_X/Y/SIZE, SIDEBAR_LIST_START_Y, LAYER_NUM_X, LAYER_VIS_X/W, LAYER_ARROW_X. Created helper methods GetMapDrawX/Y, GetMapPixelWidth/Height, GetTileSize to eliminate code duplication. Improved maintainability significantly."
        },
        {
            "id": "4.17",
            "description": "Add bounds validation",
            "status": "completed",
            "estimatedTime": "15 min",
            "actualTime": "10 min",
            "completionDate": "2025-12-26",
            "priority": "high",
            "notes": "Added cassert include for debug assertions. Validated existing bounds checks in SetTile/GetTile (layer < LAYER_COUNT), SetActiveLayer, ToggleLayerVisibility, zoom levels (0-4), fill safety limit (10k tiles). All critical paths have proper validation to prevent crashes."
        },
        {
            "id": "4.18",
            "description": "Update documentation",
            "status": "completed",
            "estimatedTime": "30 min",
            "actualTime": "25 min",
            "completionDate": "2025-12-26",
            "priority": "high",
            "notes": "Updated MAP_EDITOR_PROGRESS.md with comprehensive documentation: Layer sidebar UI details, zoom/pan system (5 levels, snap-to-grid), screen section grid explanation, checkboard background, complete keyboard shortcuts, mouse controls reference. Added enhancement features section (2025-12-26). Updated completion status, future enhancements list, and footer timestamps."
        },
        {
            "id": "4.19",
            "description": "UX polish and visual feedback",
            "status": "completed",
            "estimatedTime": "1 hour",
            "actualTime": "20 min",
            "completionDate": "2025-12-26",
            "priority": "medium",
            "notes": "Implemented toast message system with 2-second display in title bar. Added feedback for save/load operations ('Map saved!', 'Map loaded!', error messages). Timer-based auto-hide. Clean integration without additional UI elements. Simplified but effective user feedback."
        },
        {
            "id": "4.20",
            "description": "Implement continuous drawing (paint while dragging)",
            "status": "completed",
            "estimatedTime": "30 min",
            "actualTime": "25 min",
            "completionDate": "2025-12-26",
            "priority": "critical",
            "notes": "Implemented continuous drawing - pencil paints while left mouse held + dragging. Tracks last painted tile (lastDrawnTileX/Y) to prevent double-painting same tile. isDrawing state tracks mouse down. Resets on mouse release. Works at all zoom levels. Clean brush-like experience matching SpriteEditor."
        },
        {
            "id": "4.21",
            "description": "Implement Undo/Redo system",
            "status": "pending",
            "estimatedTime": "1.5 hours",
            "priority": "critical",
            "notes": "Create MapEditor_UndoRedo.cpp/h similar to SpriteEditor. Stack-based undo/redo for tile changes. Support Ctrl+Z (undo) and Ctrl+Y (redo). Store before/after tile states. Limit stack to 50 operations. Should work with all tools (pencil, fill, eraser)."
        },
        {
            "id": "4.22",
            "description": "Runtime integration - Map display in game",
            "status": "pending",
            "estimatedTime": "1 hour",
            "priority": "critical",
            "notes": "Integrate map rendering in actual game runtime. Implement mget(x, y, [layer]) and mset(x, y, [layer], tile) Lua API. Implement map(mx, my, sx, sy, w, h, [layer_mask]) for rendering. Load map.json from cartridge folder. Test with sample game that displays and scrolls the map."
        },
        {
            "id": "4.23",
            "description": "Performance profiling and optimization",
            "status": "skipped",
            "estimatedTime": "30 min",
            "priority": "low",
            "notes": "Optional: Profile rendering performance. Optimize DrawSpriteSection caching. Aggressive viewport culling. Benchmark before/after. Can be done later if performance issues arise."
        }
    ],
    "technical_specs": {
        "map_size": "128x64 tiles",
        "tile_size": "8x8 pixels (storage)",
        "display_size": "16x16 pixels (in spritesheet picker)",
        "layer_count": 8,
        "tiles_per_layer": "128 × 64 = 8,192",
        "tile_range": "0-255 (from spritesheet, 0=transparent)",
        "file_format": "JSON (nlohmann/json)",
        "tools": [
            "pencil (icon 0)",
            "fill (icon 1)",
            "eraser (icon 20 - CLEAR)",
            "picker (icon 4)",
            "grid toggle (icon 16)"
        ],
        "layout_calculated_from": "bottom-up (PICO-8 style)"
    },
    "ui_layout": {
        "style": "PICO-8 vertical (header → map → toolbar → spritesheet → footer)",
        "header": "Y=0, H=10 (light gray, black text)",
        "map_viewport": "Y=10-161, W=254 (full width with 1px white border), scrollable, grid overlay",
        "toolbar": "Y=162-181, contains tool buttons (left, x=0) and tab buttons (right, x=192-255)",
        "spritesheet": "Y=182-245, W=256 (full width), 16 cols × 4 rows = 64 tiles per tab",
        "footer": "Y=246-255, H=10 (light gray, shows position, tool, tile, tab)",
        "tab_system": "4 tabs (1-4), 16x16 buttons, green when active, numbers centered",
        "borders": {
            "map": "full-width white border (x=0, w=256)",
            "tools": "white on left/top/right only (no bottom to avoid double line)",
            "tabs": "white on left/top/right only (no bottom to avoid double line)",
            "spritesheet": "white on all sides"
        },
        "colors": {
            "background": "UI_CANVAS_BG",
            "grid": "DARK_GRAY",
            "active_tool": "GREEN",
            "inactive_tool": "DARK_GRAY",
            "active_tab": "GREEN",
            "border": "WHITE",
            "header_footer": "LIGHT_GRAY with BLACK text"
        }
    },
    "map_data_format": {
        "format": "JSON",
        "structure": {
            "version": "1.0",
            "width": 128,
            "height": 64,
            "tileSize": 8,
            "layers": [
                {
                    "id": 0,
                    "name": "Layer 0",
                    "visible": true,
                    "opacity": 100,
                    "data": "array[8192] of uint8_t tile IDs"
                }
            ]
        },
        "example_path": "cartridges/test_collision/map.json"
    },
    "dependencies": [
        "✅ AestheticLayer (rendering)",
        "✅ InputManager (mouse/keyboard)",
        "✅ SystemSprites (tool icons)",
        "✅ SystemColors (UI theming)",
        "✅ nlohmann/json (JSON save/load)",
        "✅ Spritesheet (tile source - 256 tiles)",
        "✅ Engine (F3 toggle, mode switching)"
    ],
    "testing_checklist": [
        "✅ Place tiles with pencil",
        "✅ Fill areas with tile (iterative flood fill)",
        "✅ Erase tiles (sets to 0)",
        "✅ Pick tiles from map",
        "✅ Switch between layers (1-8 keys)",
        "✅ Toggle grid (G key)",
        "✅ Scroll viewport with arrow keys",
        "✅ Select tiles from spritesheet (16x4 grid)",
        "✅ Switch tabs (1-4) for 256 tiles",
        "✅ Save map.json (Ctrl+S)",
        "✅ Load map.json (on Initialize)",
        "✅ Toggle editor with F3",
        "✅ Verify layer compositing order (bottom-to-top)",
        "✅ UI borders and spacing correct",
        "✅ Full-width layout (map and spritesheet)",
        "✅ Tool/tab buttons at screen edges"
    ],
    "implementation_highlights": [
        "Vertical PICO-8 layout calculated from bottom-up for perfect spacing",
        "Tab system matches Sprite Editor exactly (16x16, 3D borders, centered numbers)",
        "Iterative flood fill prevents stack overflow on large areas",
        "Full-width white borders for professional look",
        "Tool buttons start at x=0, tab buttons end at x=256 (screen edges)",
        "1px spacing between toolbar and spritesheet (no double white line)",
        "Map viewport auto-calculates height (152px) to fill available space",
        "SystemSprites integration for all tool icons",
        "Camera bounds checking prevents scrolling out of map",
        "Tile 0 treated as transparent for proper layering"
    ],
    "pending_enhancements": {
        "description": "Additional features to enhance the Map Editor beyond core functionality",
        "tasks": [
            {
                "id": "4.13",
                "title": "Load Cartridge Spritesheet",
                "priority": "HIGH",
                "reason": "Currently using placeholder colors - need to load actual sprites from cartridge",
                "implementation": [
                    "Access Engine's loaded spritesheet data",
                    "Pass spritesheet pointer to MapEditor on Initialize",
                    "Update RenderMapViewport to use DrawSprite instead of colored rects",
                    "Update RenderSpritesheet to show actual sprites",
                    "Handle spritesheet reload when switching cartridges"
                ],
                "dependencies": [
                    "Engine spritesheet loader",
                    "AestheticLayer::DrawSprite"
                ]
            },
            {
                "id": "4.14",
                "title": "Layer Management UI Panel",
                "priority": "MEDIUM",
                "reason": "Need visual feedback and controls for layer operations beyond 1-8 keys",
                "implementation": [
                    "Add small panel in space between map and toolbar (Y=152-162, 10px height)",
                    "Show 8 layer indicators with:",
                    "- Layer number and name",
                    "- Visibility toggle (eye icon)",
                    "- Active layer highlight (yellow)",
                    "- Click to select layer",
                    "- Right-click for context menu (rename, delete, etc.)",
                    "Style matching PICO-8 aesthetic"
                ],
                "ui_space": "10px vertical space between map (Y=161) and toolbar (Y=162)",
                "features": [
                    "visibility toggle",
                    "active selection",
                    "layer naming",
                    "reordering"
                ]
            },
            {
                "id": "4.15",
                "title": "PICO-8 Style Zoom & Pan",
                "priority": "HIGH",
                "reason": "Essential for large map editing - see entire 128x64 map and zoom into regions",
                "implementation": [
                    "Show entire 128x64 map in viewport initially (fit to 254x150)",
                    "Middle mouse button + drag to pan camera",
                    "Mouse wheel to zoom in/out (0.25x to 4x range)",
                    "Zoom centered on mouse cursor position",
                    "Mini overview in corner showing camera position",
                    "Smooth zoom/pan transitions",
                    "Update grid rendering for zoomed view"
                ],
                "zoom_levels": [
                    "0.25x (entire map)",
                    "0.5x",
                    "1.0x (1:1)",
                    "2.0x",
                    "4.0x (pixel detail)"
                ],
                "controls": {
                    "pan": "Middle mouse + drag",
                    "zoom": "Mouse wheel up/down",
                    "reset": "Home key (zoom to fit entire map)"
                },
                "reference": "PICO-8 map editor - see Recording 2025-12-25 164810.gif"
            }
        ],
        "estimatedTotalTime": "4 hours",
        "priority_order": [
            "4.13 (spritesheet)",
            "4.15 (zoom/pan)",
            "4.14 (layer UI)"
        ]
    }
}